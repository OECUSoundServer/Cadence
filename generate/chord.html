<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>ã‚³ãƒ¼ãƒ‰åˆ¶ä½œæ”¯æ´ãƒ„ãƒ¼ãƒ« Î²ç‰ˆ</title>
        <style>
            body {
                font-family: sans-serif;
                max-width: 700px;
                margin: 2em auto;
            }
            input, select {
                width: 100%;
                padding: 8px;
                margin: 8px 0;
            }
            .suggestions button {
                margin: 4px;
                padding: 6px 10px;
                font-size: 1em;
            }
            .result {
                margin-top: 1em;
                font-weight: bold;
            }
            #patternList {
                background: #f8f8f8;
                padding: 10px;
                border: 1px solid #ccc;
                margin-top: 10px;
                font-size: 0.95em;
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>ã‚³ãƒ¼ãƒ‰é€²è¡Œ æ”¯æ´ãƒ„ãƒ¼ãƒ«</h1>

        <label>æ›²ã®Keyã‚’é¸æŠï¼š</label>
        <select id="keySelect" onchange="suggestNextChord(); updateUrlFromInput()">
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="G">G</option>
            <option value="A">A</option>
            <option value="B">B</option>
        </select>

        <label>ã‚³ãƒ¼ãƒ‰é€²è¡Œã‚’å…¥åŠ›ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰:</label>
        <input type="text" id="codeInput" placeholder="ä¾‹: C G Am" oninput="suggestNextChord(); updateUrlFromInput()">

        <div class="result">æ¬¡ã«æ¥ãã†ãªã‚³ãƒ¼ãƒ‰å€™è£œï¼š</div>
        <div class="suggestions" id="suggestionsBox"></div>

        <div class="result">ã‚³ãƒ¼ãƒ‰ã®å½¹å‰²ï¼š</div>
        <div id="functionBox" style="margin-bottom: 1em;"></div>

        <div class="result">ä»£ç†ã‚³ãƒ¼ãƒ‰å€™è£œï¼š</div>
        <div id="substitutionBox"></div>

        <div class="result">è‡ªç”±ç™ºæƒ³ã‚³ãƒ¼ãƒ‰å€™è£œ(ãƒ†ã‚¹ãƒˆ):</div>
        <div id="creativeBox"></div>

        <div class="result">ãƒ©ãƒ³ãƒ€ãƒ ã‚³ãƒ¼ãƒ‰:</div>
        <div id="randomBox"></div>

        <div class="result">é›°å›²æ°—ã‚¹ã‚³ã‚¢ï¼š</div>
        <div id="moodBox"></div>

        <div class="result">ã‚³ãƒ¼ãƒ‰ä½¿ç”¨çµ±è¨ˆï¼š</div>
        <div id="usageBox"></div>

        <hr>
        <h3>ã‚³ãƒ¼ãƒ‰é€²è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¿½åŠ ï¼ˆJSONå½¢å¼ï¼‰:</h3>
        <input type="file" id="patternFile" accept=".json" onchange="loadPatternFile()">

        <h3>
            <button onclick="togglePatternList()">ğŸ“– ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è¦§ã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
        </h3>
        <div id="patternList"></div>

        <button onclick="copyCurrentUrl()">ğŸ”— ç¾åœ¨ã®URLã‚’ã‚³ãƒ”ãƒ¼</button>
        <button onclick="exportCurrentPattern()">ğŸ“¥ ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰é€²è¡Œã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ä¿å­˜</button>

        <script>
            const chromatic = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

            const patterns = [
                { name: "ç‹é“é€²è¡Œ", chords: ["C", "G", "Am", "F"] },
                { name: "ã‚«ãƒãƒ³é€²è¡Œ", chords: ["C", "G", "Am", "Em", "F", "C", "F", "G"] },
                { name: "å°å®¤é€²è¡Œ", chords: ["Am", "F", "G", "C"] },
                { name: "çˆ½ã‚„ã‹é€²è¡Œ", chords: ["C", "Em", "F", "G"] },
                { name: "å¾ªç’°ã‚³ãƒ¼ãƒ‰", chords: ["Dm7", "G7", "Cmaj7", "Am7"] },
                { name: "ä¸¸ã‚µé€²è¡Œ", chords: ["F", "G", "Em", "Am"] },
                { name: "J-POPå®šç•ªé€²è¡Œ", chords: ["Em", "G", "C", "D"] },
                { name: "åˆ‡ãªã„é€²è¡Œ", chords: ["Am", "G", "F", "G"] },
                { name: "å¹»æƒ³çš„é€²è¡Œ", chords: ["C", "F", "G", "Em"] },
                { name: "ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«é€²è¡Œ", chords: ["C", "Am", "F", "G"] },
                { name: "æš—ã„é›°å›²æ°—é€²è¡Œ", chords: ["Am", "F", "Dm", "E"] },
                { name: "ãƒŠãƒãƒ¥ãƒ©ãƒ«ãƒã‚¤ãƒŠãƒ¼é€²è¡Œ", chords: ["Am", "G", "F", "E"] },
                { name: "æ˜­å’Œæ­Œè¬¡é€²è¡Œ", chords: ["C", "Am", "D7", "G7"] },
                { name: "ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ é¢¨", chords: ["Dm", "Bb", "Gm", "A"] },
                { name: "ZUNé€²è¡Œ", chords: ["A#", "C", "Dm"] }, // Fâ†’Gâ†’Am â†’ ç§»èª¿ã§ A#â†’Câ†’Dm
                { name: "æ³¥é…”", chords: ["Dm", "C", "A#"] }, // Amâ†’Gâ†’F â†’ ç§»èª¿ã§ Dmâ†’Câ†’A#
                { name: "ã˜ã‚‰ã—", chords: ["A#", "C", "A#", "C", "Dm"] }, // Fâ†’Gâ†’Fâ†’Gâ†’Am â†’ A#â†’Câ†’A#â†’Câ†’Dm
                { name: "ãƒ€ãƒ¼ã‚¯ç¥ä¸»", chords: ["A#", "C", "C#dim"] }, // Fâ†’Gâ†’G#dim â†’ A#â†’Câ†’C#dim
                { name: "ã‚¨ãƒ³ã‚¸ã‚§ãƒ«ç¥ä¸»", chords: ["A#", "C", "D"] }, // Fâ†’Gâ†’Aï¼ˆå€Ÿç”¨ï¼‰â†’ A#â†’Câ†’D
                { name: "æ˜‡ç«œæ‹³", chords: ["A#", "C", "E", "F#", "A#", "C", "Dm"] }, // Fâ†’Gâ†’Bâ†’C#â†’Fâ†’Gâ†’Am â†’ A#â†’Câ†’Eâ†’F#â†’A#â†’Câ†’Dm
                { name: "ã©ã‚“ã§ã‚“è¿”ã—", chords: ["A#", "C", "G"] }, // Fâ†’Gâ†’C â†’ A#â†’Câ†’G
                { name: "å››æ®µæµã—", chords: ["Dm", "C", "A#", "A"] }, // Amâ†’Gâ†’Fâ†’E â†’ Dmâ†’Câ†’A#â†’A
                { name: "æ¼¸è¿‘ç·š", chords: ["Dm", "C", "F"] }, // Amâ†’Gâ†’D â†’ Dmâ†’Câ†’F
                { name: "åšéº—é€²è¡Œ", chords: ["Dm", "F", "Em", "A#", "C"] },// Amâ†’Câ†’Bmâ†’Fâ†’G â†’ Dmâ†’Fâ†’Emâ†’A#â†’C
                { name: "åå­—è»é€²è¡Œ", chords: ["Dm", "A#", "C", "Am", "A#", "D", "G"] }
            ];

            const chordFunctionsInC = {
                "C":        { degree: "I", role: "ãƒˆãƒ‹ãƒƒã‚¯" },
                "Cmaj7":    { degree: "Imaj7", role: "ãƒˆãƒ‹ãƒƒã‚¯ï¼ˆæŸ”ã‚‰ã‹ã„ï¼‰" },
                "C7":       { degree: "I7", role: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆçš„ãªå¤‰åŒ–" },
                "Dm":       { degree: "ii", role: "ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                "Dm7":      { degree: "ii7", role: "ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆï¼ˆæŸ”ã‚‰ã‹ã„ï¼‰" },
                "Em":       { degree: "iii", role: "ãƒˆãƒ‹ãƒƒã‚¯çš„" },
                "Em7":      { degree: "iii7", role: "ãƒˆãƒ‹ãƒƒã‚¯çš„ï¼ˆã‚¸ãƒ£ã‚¸ãƒ¼ï¼‰" },
                "F":        { degree: "IV", role: "ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                "G":        { degree: "V", role: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                "G7":       { degree: "V7", role: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆï¼ˆå¼·ã„ï¼‰" },
                "Am":       { degree: "vi", role: "ãƒˆãƒ‹ãƒƒã‚¯çš„ï¼ˆåˆ‡ãªã„ï¼‰" },
                "Am7":      { degree: "vi7", role: "ãƒˆãƒ‹ãƒƒã‚¯çš„ï¼ˆæŸ”ã‚‰ã‹ã„ï¼‰" },
                "Bdim":     { degree: "viiÂ°", role: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆçš„ï¼ˆä¸å®‰å®šï¼‰" },
                "Csus4":    { degree: "I(sus4)", role: "è£…é£¾çš„ãƒˆãƒ‹ãƒƒã‚¯" },
                "Cadd9":    { degree: "I(add9)", role: "çˆ½ã‚„ã‹ãƒˆãƒ‹ãƒƒã‚¯" }
            };
            

            const substitutionMap = {
                "C": [
                    { chord: "Am", reason: "æ§‹æˆéŸ³ãŒé‡ãªã‚Šãƒˆãƒ‹ãƒƒã‚¯çš„ãªå½¹å‰²ã‚’æŒã¤" },
                    { chord: "Em", reason: "åŒã˜ãƒˆãƒ‹ãƒƒã‚¯æ©Ÿèƒ½ã‚’æŒã¤" },
                    { chord: "Cmaj7", reason: "ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’åŠ ãˆãŸãƒˆãƒ‹ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰" }
                ],
                "Am": [
                    { chord: "C", reason: "æ§‹æˆéŸ³ãŒè¿‘ããƒˆãƒ‹ãƒƒã‚¯æ©Ÿèƒ½ãŒå…±é€šã™ã‚‹" },
                    { chord: "Em", reason: "åŒã˜ãƒˆãƒ‹ãƒƒã‚¯çš„ãªå½¹å‰²ã‚’æŒã¤" },
                    { chord: "F", reason: "å¹³è¡Œèª¿ã‹ã‚‰ã®å€Ÿç”¨ã«ã‚ˆã‚‹æŸ”ã‚‰ã‹ã„éŸ¿ã" }
                ],
                "F": [
                    { chord: "Dm", reason: "æ©Ÿèƒ½çš„ã«è¿‘ã„ãŸã‚ï¼ˆã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆï¼‰" },
                    { chord: "Bb", reason: "IVã®ä»£ç†ï¼ˆå€Ÿç”¨ã‚³ãƒ¼ãƒ‰ï¼‰" },
                    { chord: "Fmaj7", reason: "ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’åŠ ãˆãŸã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" }
                ],
                "Dm": [
                    { chord: "F", reason: "æ©Ÿèƒ½çš„ã«è¿‘ã„ãŸã‚ï¼ˆã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆï¼‰" },
                    { chord: "Bb", reason: "ä»£ç†çš„ãªIV" },
                    { chord: "Fmaj7", reason: "å’Œå£°çš„ã«è¿‘ã„ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" }
                ],
                "G": [
                    { chord: "Bdim", reason: "åŒã˜ãƒ‰ãƒŸãƒŠãƒ³ãƒˆçš„æ©Ÿèƒ½ã‚’æŒã¤" },
                    { chord: "E7", reason: "ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒ‰ãƒŸãƒŠãƒ³ãƒˆï¼ˆAãƒã‚¤ãƒŠãƒ¼ã¸ï¼‰" },
                    { chord: "G7", reason: "ã‚ˆã‚Šå¼·ã„ãƒ‰ãƒŸãƒŠãƒ³ãƒˆæ„Ÿã‚’æŒãŸã›ã‚‹" }
                ],
                "G7": [
                    { chord: "G", reason: "ã‚ˆã‚Šå®‰å®šã—ãŸéŸ¿ãã¸ã®ç°¡ç•¥åŒ–" },
                    { chord: "Bdim", reason: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆä»£ç†ã¨ã—ã¦ä½¿ç”¨å¯èƒ½" }
                ],
                "Bdim": [
                    { chord: "G", reason: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆã®ä»£ç†ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹" },
                    { chord: "E7", reason: "ã‚ˆã‚Šå¼·ããƒˆãƒ‹ãƒƒã‚¯ã¸é€²è¡Œã•ã›ã‚‹ä»£ç†ã‚³ãƒ¼ãƒ‰" }
                ],
                "Em": [
                    { chord: "Cmaj7", reason: "ãƒˆãƒ‹ãƒƒã‚¯çš„ãªéŸ¿ãã‚’æŒã¤" },
                    { chord: "Am", reason: "ãƒˆãƒ‹ãƒƒã‚¯çš„ãªä»£ç†ã‚³ãƒ¼ãƒ‰" }
                ],
                "Cmaj7": [
                    { chord: "Em", reason: "æ§‹æˆéŸ³ãŒä¼¼ã¦ãŠã‚Šãƒˆãƒ‹ãƒƒã‚¯çš„" },
                    { chord: "Am7", reason: "æŸ”ã‚‰ã‹ãéŸ¿ãä»£ç†ãƒˆãƒ‹ãƒƒã‚¯" }
                ],
                "Fmaj7": [
                    { chord: "Dm7", reason: "æ§‹æˆéŸ³ãŒä¼¼ãŸã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆçš„ã‚³ãƒ¼ãƒ‰" },
                    { chord: "Bbmaj7", reason: "IVã®å€Ÿç”¨ã‚³ãƒ¼ãƒ‰" }
                ],
                "D7": [
                    { chord: "F#dim", reason: "ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒ‰ãƒŸãƒŠãƒ³ãƒˆã®ä»£ç†" }
                ],
                "A7": [
                    { chord: "C#dim", reason: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆã‚»ãƒ–ãƒ³ã‚¹ã®ä»£ç†ã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹" }
                ],
                "E7": [
                    { chord: "G#dim", reason: "ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒ‰ãƒŸãƒŠãƒ³ãƒˆã®ä»£ç†" }
                ],
                "Csus4": [
                    { chord: "C", reason: "è§£æ±ºå…ˆã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹å®‰å®šã‚³ãƒ¼ãƒ‰" }
                ],
                "Cadd9": [
                    { chord: "C", reason: "åŸºæœ¬ã‚³ãƒ¼ãƒ‰ã«ãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã‚’åŠ ãˆãŸå½¢" }
                ]
            };

            const brightnessScoreInC = {
                "C": 1,
                "C7": 0,
                "Cm": -1,
                "Cm7": -1,
                "CM7": 1,
                "CmM7": -1,
                "Csus4": 0,
                "C7sus4": 0,
                "Cdim": -2,
                "Cm7-5": -2,
                "Caug": 0,
                "Cadd9": 1,
                "C6": 1,
                "Cm6": -1,
                "C#": 1,
                "C#7": 0,
                "C#m": -1,
                "C#m7": -1,
                "C#M7": 1,
                "C#mM7": -1,
                "C#sus4": 0,
                "C#7sus4": 0,
                "C#dim": -2,
                "C#m7-5": -2,
                "C#aug": 0,
                "C#add9": 1,
                "C#6": 1,
                "C#m6": -1,
                "D": 1,
                "D7": 0,
                "Dm": -1,
                "Dm7": -1,
                "DM7": 1,
                "DmM7": -1,
                "Dsus4": 0,
                "D7sus4": 0,
                "Ddim": -2,
                "Dm7-5": -2,
                "Daug": 0,
                "Dadd9": 1,
                "D6": 1,
                "Dm6": -1,
                "D#": 1,
                "D#7": 0,
                "D#m": -1,
                "D#m7": -1,
                "D#M7": 1,
                "D#mM7": -1,
                "D#sus4": 0,
                "D#7sus4": 0,
                "D#dim": -2,
                "D#m7-5": -2,
                "D#aug": 0,
                "D#add9": 1,
                "D#6": 1,
                "D#m6": -1,
                "E": 1,
                "E7": 0,
                "Em": -1,
                "Em7": -1,
                "EM7": 1,
                "EmM7": -1,
                "Esus4": 0,
                "E7sus4": 0,
                "Edim": -2,
                "Em7-5": -2,
                "Eaug": 0,
                "Eadd9": 1,
                "E6": 1,
                "Em6": -1,
                "F": 1,
                "F7": 0,
                "Fm": -1,
                "Fm7": -1,
                "FM7": 1,
                "FmM7": -1,
                "Fsus4": 0,
                "F7sus4": 0,
                "Fdim": -2,
                "Fm7-5": -2,
                "Faug": 0,
                "Fadd9": 1,
                "F6": 1,
                "Fm6": -1,
                "F#": 1,
                "F#7": 0,
                "F#m": -1,
                "F#m7": -1,
                "F#M7": 1,
                "F#mM7": -1,
                "F#sus4": 0,
                "F#7sus4": 0,
                "F#dim": -2,
                "F#m7-5": -2,
                "F#aug": 0,
                "F#add9": 1,
                "F#6": 1,
                "F#m6": -1,
                "G": 1,
                "G7": 0,
                "Gm": -1,
                "Gm7": -1,
                "GM7": 1,
                "GmM7": -1,
                "Gsus4": 0,
                "G7sus4": 0,
                "Gdim": -2,
                "Gm7-5": -2,
                "Gaug": 0,
                "Gadd9": 1,
                "G6": 1,
                "Gm6": -1,
                "G#": 1,
                "G#7": 0,
                "G#m": -1,
                "G#m7": -1,
                "G#M7": 1,
                "G#mM7": -1,
                "G#sus4": 0,
                "G#7sus4": 0,
                "G#dim": -2,
                "G#m7-5": -2,
                "G#aug": 0,
                "G#add9": 1,
                "G#6": 1,
                "G#m6": -1,
                "A": 1,
                "A7": 0,
                "Am": -1,
                "Am7": -1,
                "AM7": 1,
                "AmM7": -1,
                "Asus4": 0,
                "A7sus4": 0,
                "Adim": -2,
                "Am7-5": -2,
                "Aaug": 0,
                "Aadd9": 1,
                "A6": 1,
                "Am6": -1,
                "A#": 1,
                "A#7": 0,
                "A#m": -1,
                "A#m7": -1,
                "A#M7": 1,
                "A#mM7": -1,
                "A#sus4": 0,
                "A#7sus4": 0,
                "A#dim": -2,
                "A#m7-5": -2,
                "A#aug": 0,
                "A#add9": 1,
                "A#6": 1,
                "A#m6": -1,
                "B": 1,
                "B7": 0,
                "Bm": -1,
                "Bm7": -1,
                "BM7": 1,
                "BmM7": -1,
                "Bsus4": 0,
                "B7sus4": 0,
                "Bdim": -2,
                "Bm7-5": -2,
                "Baug": 0,
                "Badd9": 1,
                "B6": 1,
                "Bm6": -1
            };

            const chordFrequency = {
                "C": 15,
                "C7": 8,
                "Cm": 3,
                "Cm7": 3,
                "CM7": 6,
                "CmM7": 1,
                "Csus4": 5,
                "C7sus4": 3,
                "Cdim": 2,
                "Cm7-5": 2,
                "Caug": 2,
                "Cadd9": 5,
                "C6": 8,
                "Cm6": 2,
                "C#": 6,
                "C#7": 4,
                "C#m": 2,
                "C#m7": 2,
                "C#M7": 3,
                "C#mM7": 1,
                "C#sus4": 2,
                "C#7sus4": 2,
                "C#dim": 1,
                "C#m7-5": 1,
                "C#aug": 1,
                "C#add9": 2,
                "C#6": 4,
                "C#m6": 1,
                "Db": 3,
                "Db7": 2,
                "Dbm": 1,
                "Dbm7": 1,
                "DbM7": 2,
                "DbmM7": 1,
                "Dbsus4": 1,
                "Db7sus4": 1,
                "Dbdim": 1,
                "Dbm7-5": 1,
                "Dbaug": 1,
                "Dbadd9": 1,
                "Db6": 2,
                "Dbm6": 1,
                "D": 8,
                "D7": 7,
                "Dm": 6,
                "Dm7": 6,
                "DM7": 5,
                "DmM7": 1,
                "Dsus4": 3,
                "D7sus4": 2,
                "Ddim": 2,
                "Dm7-5": 2,
                "Daug": 2,
                "Dadd9": 3,
                "D6": 6,
                "Dm6": 2,
                "D#": 6,
                "D#7": 4,
                "D#m": 2,
                "D#m7": 2,
                "D#M7": 3,
                "D#mM7": 1,
                "D#sus4": 2,
                "D#7sus4": 2,
                "D#dim": 1,
                "D#m7-5": 1,
                "D#aug": 1,
                "D#add9": 2,
                "D#6": 4,
                "D#m6": 1,
                "Eb": 5,
                "Eb7": 3,
                "Ebm": 2,
                "Ebm7": 2,
                "EbM7": 2,
                "EbmM7": 1,
                "Ebsus4": 2,
                "Eb7sus4": 2,
                "Ebdim": 2,
                "Ebm7-5": 1,
                "Ebaug": 1,
                "Ebadd9": 2,
                "Eb6": 3,
                "Ebm6": 1,
                "E": 7,
                "E7": 6,
                "Em": 6,
                "Em7": 6,
                "EM7": 4,
                "EmM7": 2,
                "Esus4": 3,
                "E7sus4": 2,
                "Edim": 2,
                "Em7-5": 2,
                "Eaug": 2,
                "Eadd9": 4,
                "E6": 6,
                "Em6": 3,
                "F": 12,
                "F7": 8,
                "Fm": 3,
                "Fm7": 3,
                "FM7": 7,
                "FmM7": 2,
                "Fsus4": 4,
                "F7sus4": 3,
                "Fdim": 2,
                "Fm7-5": 2,
                "Faug": 2,
                "Fadd9": 5,
                "F6": 8,
                "Fm6": 3,
                "F#": 7,
                "F#7": 5,
                "F#m": 2,
                "F#m7": 2,
                "F#M7": 3,
                "F#mM7": 1,
                "F#sus4": 2,
                "F#7sus4": 2,
                "F#dim": 1,
                "F#m7-5": 1,
                "F#aug": 1,
                "F#add9": 2,
                "F#6": 4,
                "F#m6": 1,
                "Gb": 3,
                "Gb7": 2,
                "Gbm": 1,
                "Gbm7": 1,
                "GbM7": 2,
                "GbmM7": 1,
                "Gbsus4": 1,
                "Gb7sus4": 1,
                "Gbdim": 1,
                "Gbm7-5": 1,
                "Gbaug": 1,
                "Gbadd9": 1,
                "Gb6": 2,
                "Gbm6": 1,
                "G": 13,
                "G7": 10,
                "Gm": 3,
                "Gm7": 3,
                "GM7": 8,
                "GmM7": 2,
                "Gsus4": 5,
                "G7sus4": 4,
                "Gdim": 2,
                "Gm7-5": 2,
                "Gaug": 2,
                "Gadd9": 5,
                "G6": 10,
                "Gm6": 3,
                "G#": 5,
                "G#7": 4,
                "G#m": 2,
                "G#m7": 2,
                "G#M7": 3,
                "G#mM7": 1,
                "G#sus4": 2,
                "G#7sus4": 2,
                "G#dim": 1,
                "G#m7-5": 1,
                "G#aug": 1,
                "G#add9": 2,
                "G#6": 4,
                "G#m6": 1,
                "Ab": 3,
                "Ab7": 2,
                "Abm": 1,
                "Abm7": 1,
                "AbM7": 2,
                "AbmM7": 1,
                "Absus4": 1,
                "Ab7sus4": 1,
                "Abdim": 1,
                "Abm7-5": 1,
                "Abaug": 1,
                "Abadd9": 1,
                "Ab6": 2,
                "Abm6": 1,
                "A": 7,
                "A7": 6,
                "Am": 10,
                "Am7": 10,
                "AM7": 4,
                "AmM7": 2,
                "Asus4": 3,
                "A7sus4": 2,
                "Adim": 2,
                "Am7-5": 2,
                "Aaug": 2,
                "Aadd9": 4,
                "A6": 6,
                "Am6": 4,
                "A#": 4,
                "A#7": 3,
                "A#m": 3,
                "A#m7": 3,
                "A#M7": 2,
                "A#mM7": 1,
                "A#sus4": 2,
                "A#7sus4": 2,
                "A#dim": 1,
                "A#m7-5": 1,
                "A#aug": 1,
                "A#add9": 2,
                "A#6": 3,
                "A#m6": 1,
                "Bb": 5,
                "Bb7": 3,
                "Bbm": 2,
                "Bbm7": 2,
                "BbM7": 2,
                "BbmM7": 1,
                "Bbsus4": 2,
                "Bb7sus4": 2,
                "Bbdim": 1,
                "Bbm7-5": 1,
                "Bbaug": 1,
                "Bbadd9": 2,
                "Bb6": 3,
                "Bbm6": 1,
                "B": 5,
                "B7": 4,
                "Bm": 4,
                "Bm7": 4,
                "BM7": 2,
                "BmM7": 1,
                "Bsus4": 2,
                "B7sus4": 2,
                "Bdim": 1,
                "Bm7-5": 2,
                "Baug": 1,
                "Badd9": 2,
                "B6": 3,
                "Bm6": 2
            };

            function normalizeChord(chord) {
                return chord.trim().replace(/[^A-G#bm7]/g, "");
            }

            function transposeChord(chord, semitoneShift) {
                const rootMatch = chord.match(/^[A-G][#b]?/);
                if (!rootMatch) return chord;
                const root = rootMatch[0];
                const suffix = chord.slice(root.length);
                const index = chromatic.indexOf(root);
                if (index === -1) return chord;
                const transposed = chromatic[(index + semitoneShift + 12) % 12];
                return transposed + suffix;
            }

            function getSemitoneShift(fromKey, toKey) {
                return chromatic.indexOf(toKey) - chromatic.indexOf(fromKey);
            }

            function matchPatterns(userChordsInC) {
                const matches = [];
                const userNorm = userChordsInC.map(normalizeChord);
                for (const pattern of patterns) {
                    const patternNorm = pattern.chords.map(normalizeChord);
                    if (userNorm.join(",") === patternNorm.join(",")) {
                        matches.push({ name: pattern.name, score: 1.0 });
                        continue;
                    }
                    for (let i = 0; i <= userNorm.length - patternNorm.length; i++) {
                        const slice = userNorm.slice(i, i + patternNorm.length);
                        let matchCount = 0;
                        for (let j = 0; j < patternNorm.length; j++) {
                            if (slice[j] === patternNorm[j]) matchCount++;
                        }
                        const score = matchCount / patternNorm.length;
                        if (score >= 0.75) {
                            matches.push({ name: pattern.name, score });
                            break;
                        }
                    }
                }
                return matches;
            }

            function suggestNextChord() {
                const key = document.getElementById("keySelect").value;
                const userChords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const userKeyShift = getSemitoneShift(key, "C");

                const box = document.getElementById("suggestionsBox");
                box.innerHTML = "";

                if (userChords.length === 0) {
                    box.textContent = "ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                    return;
                }

                const lastUserChord = userChords[userChords.length - 1];
                const lastChordInC = transposeChord(lastUserChord, userKeyShift);

                const nextCounts = {};
                let totalNext = 0;

                for (const pattern of patterns) {
                    for (let i = 0; i < pattern.chords.length - 1; i++) {
                        const curr = normalizeChord(pattern.chords[i]);
                        const next = pattern.chords[i + 1];
                        if (curr === normalizeChord(lastChordInC)) {
                            const nextInUserKey = transposeChord(next, -userKeyShift);
                            nextCounts[nextInUserKey] = (nextCounts[nextInUserKey] || 0) + 1;
                            totalNext++;
                        }
                    }
                }

                if (totalNext === 0) {
                    box.textContent = "å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                } else {
                    Object.entries(nextCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([chord, count]) => {
                        const percent = Math.round((count / totalNext) * 100);
                        const btn = document.createElement("button");
                        btn.textContent = `${chord}ï¼ˆ${percent}%ï¼‰`;
                        btn.onclick = () => {
                            document.getElementById("codeInput").value += " " + chord;
                            suggestNextChord();
                            updateUrlFromInput();
                        };
                        box.appendChild(btn);
                    });
                }

                const userChordsInC = userChords.map(chord => transposeChord(chord, userKeyShift));
                const matchedList = matchPatterns(userChordsInC);

                if (matchedList.length > 0) {
                    const group = document.createElement("div");
                    group.style.marginTop = "1em";
                    matchedList.forEach(m => {
                        const msg = document.createElement("div");
                        msg.style.fontWeight = "bold";
                        msg.style.color = m.score === 1.0 ? "green" : "orange";
                        msg.textContent = m.score === 1.0 ?
                            `ã“ã®é€²è¡Œã¯ã€Œ${m.name}ã€ãã®ã‚‚ã®ã§ã™ï¼` :
                            `ã€Œ${m.name}ã€ã«ä¼¼ã¦ã„ã¾ã™ï¼ˆ${Math.round(m.score * 100)}%ä¸€è‡´ï¼‰`;
                        group.appendChild(msg);
                    });
                    box.appendChild(group);
                }

                showChordFunctions();
                showSubstitutions();
                showMoodScore();
                showCreativeSuggestions();
                showChordUsageStats();
            }

            function getFunctionColor(role) {
                if (role.includes("ãƒˆãƒ‹ãƒƒã‚¯")) return "#d0eaff"; // é’ç³»
                if (role.includes("ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ")) return "#d9f5d9"; // ç·‘ç³»
                if (role.includes("ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ")) return "#ffd6d6"; // èµ¤ç³»
                return "#eeeeee"; // ãã®ä»–
            }

            function showChordFunctions() {
                const key = document.getElementById("keySelect").value;
                const inputChords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const userKeyShift = getSemitoneShift(key, "C");

                const functionBox = document.getElementById("functionBox");
                functionBox.innerHTML = "";

                const maxVisible = 5; // å¸¸æ™‚è¡¨ç¤ºã™ã‚‹ä»¶æ•°
                const hiddenContainer = document.createElement("div");
                hiddenContainer.id = "hiddenFunctionContainer";
                hiddenContainer.style.display = "none";

                inputChords.forEach((ch, idx) => {
                    const chordInC = transposeChord(ch, userKeyShift);
                    const chordFunctions = isMinorKey(key) ? chordFunctionsInAm : chordFunctionsInC;
                    const info = chordFunctions[normalizeChord(chordInC)];
                    // const info = chordFunctionsInC[normalizeChord(chordInC)];
                    const div = document.createElement("div");

                    if (info) {
                        div.textContent = `${ch}ï¼ˆ${info.degree}ï¼š${info.role}ï¼‰`;
                        div.style.background = getFunctionColor(info.role);
                        div.style.padding = "4px";
                        div.style.margin = "2px 0";
                        div.style.borderRadius = "4px";
                    } else {
                        div.textContent = `${ch}ï¼ˆä¸æ˜ãªã‚³ãƒ¼ãƒ‰ï¼‰`;
                        div.style.background = "#f0f0f0";
                        div.style.padding = "4px";
                        div.style.margin = "2px 0";
                        div.style.borderRadius = "4px";
                    }

                    if (idx < inputChords.length - maxVisible) {
                        hiddenContainer.appendChild(div);
                    } else {
                        functionBox.appendChild(div);
                    }
                });

                if (hiddenContainer.children.length > 0) {
                    const toggleBtn = document.createElement("button");
                    toggleBtn.textContent = "â–¼ã™ã¹ã¦è¡¨ç¤º";
                    toggleBtn.style.marginTop = "6px";
                    toggleBtn.onclick = () => {
                        const isHidden = hiddenContainer.style.display === "none";
                        hiddenContainer.style.display = isHidden ? "block" : "none";
                        toggleBtn.textContent = isHidden ? "â–²ãŸãŸã‚€" : "â–¼ã™ã¹ã¦è¡¨ç¤º";
                    };
                    functionBox.prepend(hiddenContainer);
                    functionBox.appendChild(toggleBtn);
                }
            }

            function showSubstitutions() {
                const key = document.getElementById("keySelect").value;
                const inputChords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const userKeyShift = getSemitoneShift(key, "C");
                const subBox = document.getElementById("substitutionBox");
                subBox.innerHTML = "";
                if (inputChords.length === 0) return;
                const lastChord = inputChords[inputChords.length - 1];
                const chInC = normalizeChord(transposeChord(lastChord, userKeyShift));
                const subs = substitutionMap[chInC];
                if (subs) {
                    const wrapper = document.createElement("div");
                    wrapper.style.display = "inline-flex";
                    wrapper.style.flexWrap = "wrap";
                    wrapper.style.alignItems = "center";

                    const line = document.createElement("span");
                    line.textContent = `${lastChord} â†’ ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ï¼š`;
                    line.style.marginRight = "6px";
                    wrapper.appendChild(line);

                    subs.forEach(subObj => {
                        const sub = subObj.chord;
                        const reason = subObj.reason || "ä»£ç†ã‚³ãƒ¼ãƒ‰ã§ã™";
                        const subInUserKey = transposeChord(sub, -userKeyShift);

                        const container = document.createElement("div");
                        container.style.marginRight = "12px";
                        container.style.marginBottom = "10px";

                        const btn = document.createElement("button");
                        btn.textContent = subInUserKey;
                        btn.onclick = () => {
                            const input = document.getElementById("codeInput");
                            const chords = input.value.trim().split(/\s+/);
                            chords[chords.length - 1] = subInUserKey;
                            input.value = chords.join(" ");
                            suggestNextChord();
                            updateUrlFromInput();
                        };

                        const reasonText = document.createElement("div");
                        reasonText.textContent = `ç†ç”±ï¼š${reason}`;
                        reasonText.style.fontSize = "0.85em";
                        reasonText.style.color = "#555";

                        container.appendChild(btn);
                        container.appendChild(reasonText);
                        wrapper.appendChild(container);
                    });

                    subBox.appendChild(wrapper);
                }
            }

            function showMoodScore() {
                const key = document.getElementById("keySelect").value;
                const inputChords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const userKeyShift = getSemitoneShift(key, "C");
                const moodBox = document.getElementById("moodBox");
                let total = 0, count = 0;
                inputChords.forEach(ch => {
                    const chInC = normalizeChord(transposeChord(ch, userKeyShift));
                    if (chInC in brightnessScoreInC) {
                        total += brightnessScoreInC[chInC];
                        count++;
                    }
                });
                const avg = count ? (total / count) : 0;
                let mood = "ä¸­æ€§çš„";
                if (avg > 0.5) mood = "æ˜ã‚‹ã‚";
                else if (avg < -0.5) mood = "æš—ã‚";
                moodBox.textContent = `é›°å›²æ°—ï¼š${mood}ï¼ˆã‚¹ã‚³ã‚¢: ${avg.toFixed(2)}ï¼‰`;
            }

            function loadPatternFile() {
                const input = document.getElementById('patternFile');
                if (!input.files || input.files.length === 0) return;
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const newPatterns = JSON.parse(e.target.result);
                        if (!Array.isArray(newPatterns)) throw new Error("ä¸æ­£ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™");
                        let addedCount = 0;
                        newPatterns.forEach(p => {
                            if (typeof p.name === "string" && Array.isArray(p.chords)) {
                                patterns.push({ name: p.name, chords: p.chords });
                                addedCount++;
                            }
                    });
                    alert(`é€²è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ ${addedCount} ä»¶è¿½åŠ ã—ã¾ã—ãŸï¼`);
                    updatePatternList();
                    suggestNextChord();
                    } catch (err) {
                        alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
                    }
                };
                reader.readAsText(file);
            }

            function updatePatternList() {
                const container = document.getElementById("patternList");
                container.innerHTML = "";
                patterns.forEach(p => {
                    const div = document.createElement("div");
                    div.textContent = `ãƒ»${p.name}: ${p.chords.join(" â†’ ")}`;
                    container.appendChild(div);
                });
            }

            function togglePatternList() {
                const container = document.getElementById("patternList");
                if (container.style.display === "none" || container.style.display === "") {
                    updatePatternList();
                    container.style.display = "block";
                } else {
                    container.style.display = "none";
                }
            }

            function showCreativeSuggestions() {
                const key = document.getElementById("keySelect").value;
                const chords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const creativeBox = document.getElementById("creativeBox");
                creativeBox.innerHTML = "";

                if (chords.length === 0) return;

                const lastChord = chords[chords.length - 1];
                const userKeyShift = getSemitoneShift(key, "C");
                const lastChordInC = normalizeChord(transposeChord(lastChord, userKeyShift));

                let creativeSuggestions = [];

                if (lastChordInC === "C") {
                    creativeSuggestions = [
                    { chord: "E7", reason: "æ¬¡ã«æ¥ã‚‹ãƒã‚¤ãƒŠãƒ¼ã‚³ãƒ¼ãƒ‰ã¸ã®å¼·ã„å°éŸ³ã‚’ä½œã‚‹ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                    { chord: "A7", reason: "æ–°ã—ã„ã‚³ãƒ¼ãƒ‰é ˜åŸŸã¸å±•é–‹ã™ã‚‹ãŸã‚ã®ãƒ‰ãƒŸãƒŠãƒ³ãƒˆæ©Ÿèƒ½ã‚’æŒã¤ã‚³ãƒ¼ãƒ‰" },
                    { chord: "Ab", reason: "å¹³è¡Œèª¿ã‹ã‚‰å€Ÿç”¨ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã§ã€é›°å›²æ°—ã®å¤‰åŒ–ã‚’ã‚‚ãŸã‚‰ã™" },
                    { chord: "Bb", reason: "äºˆæƒ³å¤–ã®è‰²åˆã„ã‚’æŒã¤ã‚³ãƒ¼ãƒ‰ã§ã€é€²è¡Œã«å¤‰åŒ–ã‚’ä¸ãˆã‚‹" }
                    ];
                } else if (lastChordInC === "Am") {
                    creativeSuggestions = [
                    { chord: "F#", reason: "ã‚¯ãƒ­ãƒãƒãƒƒã‚¯ãªå‹•ãã§æµ®éŠæ„Ÿã‚„ä¸å®‰å®šã•ã‚’ç”Ÿã‚€ã‚³ãƒ¼ãƒ‰" },
                    { chord: "D7", reason: "æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã«å¼·ãé€²è¡Œã•ã›ã‚‹ãŸã‚ã®ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                    { chord: "Cmaj7", reason: "å®‰å®šã—ãŸé›°å›²æ°—ã‚’å¼·èª¿ã™ã‚‹æ§‹æˆéŸ³ã‚’æŒã¤ã‚³ãƒ¼ãƒ‰" }
                    ];
                } else if (lastChordInC === "G") {
                    creativeSuggestions = [
                    { chord: "B7", reason: "ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆãƒã‚¤ãƒŠãƒ¼é ˜åŸŸã¸ã®æ©‹æ¸¡ã—ã‚’ã™ã‚‹ã‚³ãƒ¼ãƒ‰" },
                    { chord: "F", reason: "ä¸€æ™‚çš„ãªãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒ³ã‚¸ã‚’æ„è­˜ã•ã›ã‚‹ã‚³ãƒ¼ãƒ‰" },
                    { chord: "Eb", reason: "å¤§èƒ†ãªå¤‰åŒ–ã‚’åŠ ãˆã‚‹ãŸã‚ã®å€Ÿç”¨ã‚³ãƒ¼ãƒ‰" }
                    ];
                } else if (lastChordInC === "F") {
                    creativeSuggestions = [
                        { chord: "D7", reason: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆã‚»ãƒ–ãƒ³ã‚¹ã§æ„å¤–æ€§ã‚’ç”Ÿã‚€" },
                        { chord: "A", reason: "å¹³è¡Œèª¿Amã®Våº¦ã§è‰²å½©ã‚’ä¸ãˆã‚‹" },
                        { chord: "Db", reason: "å¤§èƒ†ãªã‚¯ãƒ­ãƒãƒãƒƒã‚¯å¤‰åŒ–ã‚’ä½œã‚‹ã‚³ãƒ¼ãƒ‰" }
                    ];
                } else if (lastChordInC === "Em") {
                    creativeSuggestions = [
                        { chord: "G#", reason: "åŠéŸ³ã®ç·Šå¼µæ„Ÿã§ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãªå±•é–‹ã‚’ä½œã‚‹" },
                        { chord: "Cmaj7", reason: "åŒã˜ãƒˆãƒ‹ãƒƒã‚¯é ˜åŸŸã‹ã‚‰ã®æŸ”ã‚‰ã‹ã„å¤‰åŒ–" },
                        { chord: "A7", reason: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆæ„Ÿã‚’æŒã£ã¦æ¬¡ã¸ã®æ¨é€²åŠ›ã‚’åŠ ãˆã‚‹" }
                    ];
                } else if (lastChordInC === "Dm") {
                    creativeSuggestions = [
                        { chord: "F#", reason: "ç•°ãªã‚‹ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ã®å€Ÿç”¨ã‚³ãƒ¼ãƒ‰ã§é›°å›²æ°—ã‚’å¤‰ãˆã‚‹" },
                        { chord: "Bdim", reason: "ä¸å®‰å®šæ„Ÿã‚’åŠ ãˆã¦é€²è¡Œã«æ¨é€²åŠ›ã‚’ä¸ãˆã‚‹" },
                        { chord: "A7", reason: "ãƒˆãƒ‹ãƒƒã‚¯ã¸ã®å¼·ã„è§£æ±ºã‚’ä¿ƒã™ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ¼ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                    ];
                }

                if (creativeSuggestions.length > 0) {
                    const container = document.createElement("div");
                    container.style.display = "flex";
                    container.style.flexDirection = "column";
                    container.style.gap = "4px";

                    const header = document.createElement("div");
                    header.textContent = `${lastChord} â†’ ã“ã‚“ãªå¤‰åŒ–ã‚‚é¢ç™½ã„ã‹ã‚‚ï¼š`;
                    header.style.marginBottom = "4px";
                    container.appendChild(header);

                    creativeSuggestions.forEach(suggestion => {
                    const chordInUserKey = transposeChord(suggestion.chord, -userKeyShift);
                    const row = document.createElement("div");

                    const btn = document.createElement("button");
                    btn.textContent = chordInUserKey;
                    btn.onclick = () => {
                        document.getElementById("codeInput").value += " " + chordInUserKey;
                        suggestNextChord();
                        updateUrlFromInput();
                    };
                    btn.style.marginRight = "8px";

                    const reason = document.createElement("span");
                    reason.textContent = `â†’ ${suggestion.reason}`;

                    row.appendChild(btn);
                    row.appendChild(reason);
                    container.appendChild(row);
                    });

                    creativeBox.appendChild(container);
                }
            }


            function showChordUsageStats() {
                const inputChords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const total = inputChords.length;
                if (total === 0) return;

                const countMap = {};
                inputChords.forEach(ch => {
                    countMap[ch] = (countMap[ch] || 0) + 1;
                });

                const usageBox = document.getElementById("usageBox");
                usageBox.innerHTML = "";

                const table = document.createElement("table");
                table.style.width = "100%";
                table.style.borderCollapse = "collapse";

                const header = document.createElement("tr");
                ["ã‚³ãƒ¼ãƒ‰", "å›æ•°", "å‰²åˆ"].forEach(text => {
                    const th = document.createElement("th");
                    th.textContent = text;
                    th.style.borderBottom = "1px solid #ccc";
                    th.style.textAlign = "left";
                    th.style.padding = "4px";
                    header.appendChild(th);
                });
                table.appendChild(header);

                Object.entries(countMap).sort((a, b) => b[1] - a[1]).forEach(([chord, count]) => {
                    const row = document.createElement("tr");
                    [chord, count, `${((count / total) * 100).toFixed(1)}%`].forEach(text => {
                    const td = document.createElement("td");
                    td.textContent = text;
                    td.style.padding = "4px";
                    row.appendChild(td);
                    });
                    table.appendChild(row);
                });

                usageBox.appendChild(table);
            }

            function copyCurrentUrl() {
                const key = document.getElementById("keySelect").value;
                const chords = document.getElementById("codeInput").value.trim().replace(/\s+/g, '+');
                const url = `${location.origin}${location.pathname}?key=${key}&chords=${chords}`;
                navigator.clipboard.writeText(url).then(() => {
                    alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                }).catch(() => {
                    alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
                });
            }

            function loadFromUrl() {
                const params = new URLSearchParams(location.search);
                const key = params.get("key");
                const chords = params.get("chords");

                if (key) {
                    document.getElementById("keySelect").value = key;
                }
                if (chords) {
                    document.getElementById("codeInput").value = chords.replace(/\+/g, ' ');
                }
            }

            function updateUrlFromInput() {
                const key = document.getElementById("keySelect").value;
                const chords = document.getElementById("codeInput").value.trim().replace(/\s+/g, '+');
                const urlParams = new URLSearchParams();
                urlParams.set("key", key);
                urlParams.set("chords", chords);
                const newUrl = `${location.pathname}?${urlParams.toString()}`;
                history.replaceState(null, "", newUrl);
            }

            function exportCurrentPattern() {
                const key = document.getElementById("keySelect").value;
                const chords = document.getElementById("codeInput").value.trim().split(/\s+/).filter(Boolean);
                const name = prompt("ä¿å­˜ã™ã‚‹é€²è¡Œåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "æ–°ã—ã„é€²è¡Œ");

                if (!name || chords.length === 0) {
                    alert("é€²è¡ŒåãŒç©ºã€ã¾ãŸã¯ã‚³ãƒ¼ãƒ‰ãŒæœªå…¥åŠ›ã§ã™ã€‚");
                    return;
                }

                const patternData = [
                    {
                    name: name,
                    chords: chords
                    }
                ];

                const blob = new Blob([JSON.stringify(patternData, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = `${name}.json`;
                a.click();

                URL.revokeObjectURL(url);
            }

            function getWeightedRandomChords(count = 5) {
                const pool = [];
                for (const [chord, weight] of Object.entries(chordFrequency)) {
                    for (let i = 0; i < weight; i++) {
                        pool.push(chord);
                    }
                }

                const result = new Set();
                while (result.size < count && pool.length > 0) {
                    const rand = Math.floor(Math.random() * pool.length);
                    result.add(pool[rand]);
                }

                return Array.from(result);
            }

            function showRandomChords() {
                const randomBox = document.getElementById("randomBox");
                randomBox.innerHTML = ""; // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ

                const allChords = Object.keys(chordFrequency); // ä½¿ç”¨é »åº¦å®šç¾©æ¸ˆã¿ã‚³ãƒ¼ãƒ‰
                const specialChords = allChords.filter(c => !["dim", "aug", "sus", "7sus", "m7-5"].some(s => c.includes(s)));

                const pickWeighted = () => {
                    const pool = [];
                    for (let chord in chordFrequency) {
                        const weight = chordFrequency[chord];
                        if (weight > 8) { // â† ã“ã“ã§é‡ã¿8ä»¥ä¸‹ã‚’é™¤å¤–
                            for (let i = 0; i < weight; i++) {
                                pool.push(chord);
                            }
                        }
                    }
                    return pool.length > 0
                        ? pool[Math.floor(Math.random() * pool.length)]
                        : null; // poolãŒç©ºãªã‚‰nullã‚’è¿”ã™
                };

                const pickWeightedWithNoise = () => {
                    const pool = [];
                    for (let chord in chordFrequency) {
                        const base = chordFrequency[chord];
                        const noisyWeight = Math.max(1, base + Math.floor(Math.random() * 3) - 1);
                        if (!["dim", "aug", "sus", "7sus", "m7-5"].some(s => chord.includes(s))) {
                            for (let i = 0; i < noisyWeight; i++) pool.push(chord);
                        }
                    }
                    return pool[Math.floor(Math.random() * pool.length)];
                };

                const pickTrulyRandom = () => {
                    const fullList = Object.keys(chordFrequency);
                    return fullList[Math.floor(Math.random() * fullList.length)];
                };

                const candidates = [
                    { chord: pickWeighted(), color: "#d9f5d9" },
                    { chord: pickWeighted(), color: "#d9f5d9" },
                    { chord: pickWeightedWithNoise(), color: "#fff3cd" },
                    { chord: pickWeightedWithNoise(), color: "#fff3cd" },
                    { chord: pickTrulyRandom(), color: "#f8d7da" }
                ];

                candidates.forEach(({ chord, color }) => {
                    const btn = document.createElement("button");
                    btn.textContent = chord;
                    btn.onclick = () => {
                        const input = document.getElementById("codeInput");
                        input.value += (input.value.trim() ? " " : "") + chord;
                        suggestNextChord?.();
                        updateUrlFromInput?.();
                        showRandomChords(); // æŠ¼ã™ãŸã³ã«å†æŠ½é¸
                    };
                    btn.style.marginRight = "6px";
                    btn.style.marginBottom = "6px";
                    btn.style.backgroundColor = color;
                    btn.style.border = "1px solid #ccc";
                    btn.style.borderRadius = "4px";
                    btn.style.padding = "4px 8px";
                    randomBox.appendChild(btn);
                });
            }

            // åˆæœŸè¡¨ç¤ºã§ã‚‚å‘¼ã³å‡ºã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’æœ‰åŠ¹ã«ï¼š
            document.addEventListener("DOMContentLoaded", () => {
                showRandomChords();
            });

            function isMinorKey(key) {
                return key.endsWith("m");
            }

            const chordFunctionsInAm = {
                "Am":   { degree: "i", role: "ãƒˆãƒ‹ãƒƒã‚¯" },
                "Bdim": { degree: "iiÂ°", role: "ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆçš„" },
                "C":    { degree: "III", role: "ãƒˆãƒ‹ãƒƒã‚¯çš„" },
                "Dm":   { degree: "iv", role: "ã‚µãƒ–ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                "E":    { degree: "V", role: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆ" },
                "F":    { degree: "VI", role: "ãƒˆãƒ‹ãƒƒã‚¯çš„" },
                "G":    { degree: "VII", role: "ãƒ‰ãƒŸãƒŠãƒ³ãƒˆçš„" }
            };

            loadFromUrl();
            suggestNextChord();
            updateUrlFromInput();
        </script>
    </body>
</html>